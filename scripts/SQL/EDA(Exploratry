/*


*/
	-- A Report That Shows All Key Metrics of The Business

SELECT 'Total Sales' as measure_name, ROUND(SUM(usd_price), 2) AS measure_value FROM Elist_tech_cleaned.dbo.orders
UNION ALL
SELECT 'Total Orders' as measure_name, COUNT(DISTINCT id) AS measure_value FROM Elist_tech_cleaned.dbo.orders
UNION ALL
SELECT 'Average Sales/Price' as measure_name, ROUND(AVG(usd_price),2) AS measure_value FROM Elist_tech_cleaned.dbo.orders
UNION ALL
SELECT 'Total Nr. Product Category' as measure_name, COUNT(DISTINCT product_name) AS measure_value FROM Elist_tech_cleaned.dbo.orders
UNION ALL
SELECT 'Total Nr. Products' as measure_name, COUNT(product_id) AS measure_value FROM Elist_tech_cleaned.dbo.orders
UNION ALL
SELECT 'Total Nr. Customers ' as measure_name, COUNT( DISTINCT customer_id) AS measure_value FROM Elist_tech_cleaned.dbo.orders


/* For detailed Data Exploratory Analysis please see.*/


-- Explore All Countries

SELECT DISTINCT country FROM elist_tech_cleaned.dbo.geo_lookup

-- DATE EXPLORATION
	-- The scope of data and the timespan

SELECT MIN(purchase_ts) first_order_date, 
MAX(purchase_ts) last_order_date,
DATEDIFF(year,MIN(purchase_ts), MAX(purchase_ts)) AS order_range_years,
DATEDIFF(month,MIN(purchase_ts), MAX(purchase_ts)) AS order_range_months
FROM Elist_tech_cleaned.dbo.order_status

	-- How many days it took to ship, delivery ?

SELECT purchase_ts,
ship_ts,
delivery_ts,
refund_ts,
DATEDIFF(DAY, purchase_ts,ship_ts) AS days_to_ship,
DATEDIFF(DAY, purchase_ts,delivery_ts) AS days_to_delivery
FROM Elist_tech_cleaned.dbo.order_status

	-- How many years/months of sales are available ?

SELECT MIN(purchase_ts) first_order_date,
MAX(purchase_ts) last_order_date,
DATEDIFF(year,MIN(purchase_ts), MAX(purchase_ts)) AS order_range_years,
DATEDIFF(month,MIN(purchase_ts), MAX(purchase_ts)) AS order_range_months
FROM Elist_tech_cleaned.dbo.orders


-- MEASURES EXPLORATION 
	-- The key metrics of the business
	-- Total Sales, 
	-- Total Number of Products
	-- Avg Sales
	-- Total Orders


SELECT 
SUM(usd_price) AS total_sales,
AVG(usd_price) AS avg_sales, 
COUNT(DISTINCT id) AS total_orders
FROM Elist_tech_cleaned.dbo.orders

	-- Total number of products

SELECT COUNT( DISTINCT product_id) AS total_product,
COUNT(DISTINCT product_name) AS product_category
FROM Elist_tech_cleaned.dbo.orders

	-- Total customers

SELECT COUNT( DISTINCT id) AS total_customer
FROM Elist_tech_cleaned.dbo.customers

	-- The total number of customers that has placed an order

SELECT COUNT( DISTINCT customer_id) AS total_customer
FROM Elist_tech_cleaned.dbo.orders

-- MAGNITUDE ANALYSIS

	-- Total Customers by Country & Region

SELECT 
c.country_code, region,
COUNT(DISTINCT id) AS total_customer 
FROM Elist_tech_cleaned.dbo.customers c
LEFT JOIN Elist_tech_cleaned.dbo.geo_lookup geo
ON c.country_code = geo.country
GROUP BY c.country_code, region
ORDER BY total_customer DESC

	-- Total Products by Category

SELECT 
product_name,
COUNT(product_id) AS total_products  --?OR DISTINCT
FROM Elist_tech_cleaned.dbo.orders
GROUP BY product_name
ORDER BY total_products DESC

	-- Average sales in each Category

SELECT 
product_name,
ROUND(AVG(usd_price), 2)  AS avg_sales
FROM Elist_tech_cleaned.dbo.orders
GROUP BY product_name
ORDER BY avg_sales DESC

	-- What is the total revenue generated for each category ?

SELECT 
product_name,
SUM(usd_price) AS total_revenue
FROM Elist_tech_cleaned.dbo.orders
GROUP BY product_name
ORDER BY total_revenue DESC

	-- What is the total revenue generated by each customer ?

SELECT 
o.customer_id,
SUM(usd_price) AS total_revenue
FROM Elist_tech_cleaned.dbo.orders o
LEFT JOIN Elist_tech_cleaned.dbo.customers c
ON o.customer_id = c.id
GROUP BY o.customer_id
ORDER BY total_revenue DESC


	-- What is the distribution of sold items across countries?

SELECT 
c.country_code,
COUNT(o.id) AS total_sold_items
FROM Elist_tech_cleaned.dbo.orders o
LEFT JOIN Elist_tech_cleaned.dbo.customers c
ON o.customer_id = c.id
GROUP BY c.country_code
ORDER BY total_sold_items DESC

-- RANKING ANALYSIS 
	-- Top 5 products
	-- Bottom 10 Customers by Total Orders
	-- Which 5 products generate the highest revenue?

SELECT *
FROM (
SELECT
product_name,
SUM(usd_price) AS total_revenue,
ROW_NUMBER() OVER (ORDER BY SUM(usd_price) DESC) AS rank_products
FROM Elist_tech_cleaned.dbo.orders
GROUP BY product_name) t
WHERE rank_products <= 5

	-- What are the 5 worst performing products in terms of sales?

SELECT TOP 5
product_name,
SUM(usd_price) AS total_revenue
FROM Elist_tech_cleaned.dbo.orders
GROUP BY product_name
ORDER BY total_revenue 

	-- The top 10 customers who have generated the highest revenue

SELECT * FROM
(
SELECT 
customer_id,
COUNT(DISTINCT id) AS total_orders,
SUM(usd_price) AS total_revenue,
ROW_NUMBER() OVER (ORDER BY SUM(usd_price) DESC) AS rank_products
FROM Elist_tech_cleaned.dbo.orders
GROUP BY customer_id)t
WHERE rank_products <= 10

	-- The 10 customers with the fewest orders placed

SELECT TOP 10
customer_id,
COUNT(DISTINCT id) AS total_orders
FROM Elist_tech_cleaned.dbo.orders
GROUP BY customer_id
ORDER BY total_orders
