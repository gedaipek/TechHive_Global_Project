/*

===============================================================================
Script Purpose:
    This stored procedure performs the ETL (Extract, Transform, Load) process to 
    populate the 'silver' schema tables from the 'bronze' schema.
	Actions Performed:
		- Truncates Silver tables.
		- Inserts transformed and cleansed data from Bronze into Silver tables.
		
Parameters:
    None. 
	  This stored procedure does not accept any parameters or return any values.

Usage Example:
    EXEC Silver.load_silver;
===============================================================================
*/

USE master;
GO
IF EXISTS (SELECT 1 FROM sys.databases WHERE name = 'Elist_tech_cleaned')
BEGIN
		ALTER DATABASE Elist_tech_cleaned SET SINGLE_USER WITH ROLLBACK IMMEDIATE;
		DROP DATABASE Elist_tech_cleaned;
END;
GO

CREATE DATABASE Elist_tech_cleaned;
GO

USE Elist_tech_cleaned;
GO

IF OBJECT_ID('Elist_tech_cleaned.dbo.customers', 'U') IS NOT NULL
    DROP TABLE Elist_tech_cleaned.dbo.customers;

GO

CREATE TABLE Elist_tech_cleaned.dbo.customers(
	id						nvarchar(50),
	marketing_channel		nvarchar(50),
	account_creation_method nvarchar(50),
	country_code			nvarchar(50),
	loyalty_program			bit,
	created_on				date
);

GO

IF OBJECT_ID('Elist_tech_cleaned.dbo.geo_lookup', 'U') IS NOT NULL
    DROP TABLE Elist_tech_cleaned.dbo.geo_lookup;

GO

CREATE TABLE Elist_tech_cleaned.dbo.geo_lookup(
	country					nvarchar(50),
	region					nvarchar(50)
);

GO

IF OBJECT_ID('Elist_tech_cleaned.dbo.orders', 'U') IS NOT NULL
    DROP TABLE Elist_tech_cleaned.dbo.orders;

GO

CREATE TABLE Elist_tech_cleaned.dbo.orders(
	customer_id				nvarchar(50),
	id						nvarchar(50),
	purchase_ts				date,
	product_id				nvarchar(50),
	product_name			nvarchar(50),
	currency				nvarchar(50),
	local_price				float,
	usd_price				float,
	purchase_platform		nvarchar(50)
);

GO

IF OBJECT_ID('Elist_tech_cleaned.dbo.order_status', 'U') IS NOT NULL
    DROP TABLE Elist_tech_cleaned.dbo.order_status;

GO

CREATE TABLE Elist_tech_cleaned.dbo.order_status(
	id					nvarchar(50),
	purchase_ts			date,
	ship_ts				date,
	delivery_ts			date,
	refund_ts			date
);

GO

INSERT INTO Elist_tech_cleaned.dbo.orders (
	customer_id,
	id,
	purchase_ts,
	product_id,
	product_name,
	currency,
	local_price,
	usd_price,
	purchase_platform
)
SELECT 
customer_id,
id,
purchase_ts,
product_id,
TRIM(LOWER(REPLACE(product_name, '""',''))) AS product_name,
CASE WHEN currency IS NULL THEN 'unknown'
	 ELSE currency
END AS currency,
ROUND(local_price, 2) AS local_price,
ROUND(usd_price, 2) AS usd_price,
purchase_platform
FROM Project_Elits.dbo.order_info



GO

INSERT INTO Elist_tech_cleaned.dbo.order_status(
	id,
	purchase_ts,
	ship_ts,
	delivery_ts,
	refund_ts
)
SELECT
*
FROM Project_Elits.dbo.order_status

GO

INSERT INTO Elist_tech_cleaned.dbo.geo_lookup(
	country,
	region
)
SELECT
ISNULL(country, 'unknown') AS country,
ISNULL(region, 'unknown') AS region
FROM Project_Elits.dbo.geo_lookup




INSERT INTO Elist_tech_cleaned.dbo.customers(
	id,
	marketing_channel,
	account_creation_method,
	country_code,
	loyalty_program,
	created_on
)
SELECT
id,
ISNULL(marketing_channel, 'unknown') AS marketing_channel_updated,
ISNULL(account_creation_method, 'unknown') AS account_creation_method,
CASE WHEN country_code = 'A1' THEN 'unknown'
	 WHEN country_code IS NULL THEN 'unknown'
	 ELSE country_code
END  AS country_code,
loyalty_program,
created_on
FROM Project_Elits.dbo.customer_info

